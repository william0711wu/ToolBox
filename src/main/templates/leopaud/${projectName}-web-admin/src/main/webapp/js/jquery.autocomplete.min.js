(function(e){e.fn.extend({AutoComplete:function(n){return this.each(function(){if(!this||this.tagName!=="INPUT"||this.type!=="text")return;this.controller?this.controller.setOption(n):e.isPlainObject(n)&&(this.controller=new t(this,n))})}});var t=function(t,i){this.option=e.extend(!1,{width:320,maxHeight:null,itemHeight:null,listStyle:"normal",listDirection:"down",data:[],ajaxDataType:"json",ajaxParams:{},ajaxTimeout:3e3,ajaxType:"GET",maxItems:20,matchHandler:d,emphasisHandler:v,createItemHandler:null,beforeLoadDataHandler:null,afterSelectedHandler:null,async:!1,emphasis:!0,onerror:null,blur:null},i),n.apply(this,[t]),r.apply(this)},n=function(t){var n=this;this.inputView=e(t),this.inputView.attr("autocomplete","off").keyup(this._keyup=function(e){switch(e.keyCode){case 13:case 16:case 17:case 37:case 38:case 39:case 40:break;case 27:a.apply(n);break;default:n.option.async?setTimeout(function(){h.apply(n)},0):h.apply(n)}}).keydown(this._keydown=function(e){switch(e.keyCode){case 38:f.apply(n,["up"]);break;case 40:f.apply(n,["down"]);break;case 13:var t=n.searchView.is(":visible");l.apply(n);if(t)return!1}}).blur(this._blur=function(){var t=$(this);n.option.data&&$.each(n.option.data,function(){if(this.value==t.val())return t.attr("rel",this.rel),!1;t.attr("rel","")}),e(document).one("click",function(){a.apply(n)})})},r=function(){var t=this;this.searchView=e("<div class='ac'><ul></ul></div>").appendTo(document.body).on("mouseenter","li",function(){t.searchView.find("li.selected").removeClass("selected"),e(this).addClass("selected")}).on("mouseleave","li",function(){e(this).removeClass("selected")}).on("click","li",function(){l.apply(t),a.apply(t)}).css("font-size",this.inputView.css("font-size")),e(window).resize(function(){s.apply(t)})},i=function(t){var n=this,r=this.searchView.find("ul").empty();if(e.inArray(this.option.listStyle,["normal","iconList","custom"])==-1)throw["遇到未知的listStyle参数！"];e.each(t,function(t,i){var s=e("<li><div></div></li>").appendTo(r).addClass(n.option.listStyle).data("data",i).find("div");switch(n.option.listStyle){case"normal":s.append("<span>"+i.label+"</span>");break;case"iconList":var o=e("<img></img>").attr("src",i.image);s.append(e("<div></div>").append(o)).append("<span>"+i.label+"</span>");break;case"custom":s.append(n.option.createItemHandler.apply(n,[t,i]));case"default":}n.option.itemHeight>0&&s.height(n.option.itemHeight).css("max-height",n.option.itemHeight)})},s=function(){if(this.option.listDirection==="down")var e=this.inputView.offset().top+this.inputView.outerHeight();else{if(this.option.listDirection!=="up")throw"遇到未知的listDirection参数！";var e=this.inputView.offset().top-this.searchView.outerHeight()}var t=this.inputView.offset().left;this.searchView.css("top",e+"px").css("left",t+"px")},o=function(){if(typeof this.option.width=="string"&&this.option.width.toLowerCase()==="auto")return this.inputView.outerWidth()-2;if(typeof this.option.width=="number")return this.option.width;throw"遇到未知的width参数！"},u=function(t){var n=this;this.option.listDirection==="up"&&(t=t.reverse());try{i.apply(n,[t]),this.option.maxHeight>0&&(this.searchView.css("max-height",this.option.maxHeight+"px"),e.browser.msie&&this.searchView.css("height",this.searchView.height()>this.option.maxHeight?this.option.maxHeight+"px":"auto")),s.apply(this),this.searchView.css("width",o.apply(this)+"px")}catch(r){p.apply(this,[r+""]);return}this.searchView.show(),f.apply(this,[this.option.listDirection])},a=function(){this.searchView.find("ul").empty(),this.searchView.hide()},f=function(e){var t=this.searchView.find("li.selected");if(t.size())var n=e==="up"?t.prev():t.next();else var n=e==="up"?this.searchView.find("li").last():this.searchView.find("li").first();if(n.size()){this.searchView.find("li").removeClass("selected"),n.addClass("selected");var r=n.outerHeight(),i=n.position().top;r+i>this.searchView.height()?this.searchView.scrollTop(this.searchView.scrollTop()+i+r-this.searchView.height()):i<0&&this.searchView.scrollTop(this.searchView.scrollTop()+i)}},l=function(){var t=this,n=this.searchView.find("li.selected");if(n.size()){var r=n.data("data");this.inputView.val(r.value);if(e.isFunction(this.option.afterSelectedHandler))try{this.option.afterSelectedHandler.apply(t,[r])}catch(i){p.apply(this,["调用afterSelectedHandler错误:"+i]);return}a.apply(this)}},c=function(t){jQuery.support.cors=!0;var n=this,r=[],i={async:!1,dataType:n.option.ajaxDataType,type:n.option.ajaxType,timeout:this.option.ajaxTimeout,success:function(t,i,s){if(n.option.ajaxDataType==="xml")e(t).find("item").each(function(){var t={value:e(this).text(),label:e(this).text()};for(var n=0;n<this.attributes.length;n++){var i=this.attributes[n].nodeName,s=this.attributes[n].nodeValue;t[i]=s}r.push(t)});else{if(n.option.ajaxDataType!=="json")throw"遇到未知的ajaxDataType参数！";r=t}},error:function(e,t,n){throw n}};if(e.isPlainObject(this.option.ajaxParams))i.data=e.extend(!1,{keyword:t},this.option.ajaxParams);else if(e.isFunction(this.option.ajaxParams))i.data=e.extend(!1,{keyword:t},this.option.ajaxParams.apply(this,[t]));else{if(typeof this.option.ajaxParams!="string")throw"遇到未知的ajaxParams参数！";i.data="keyword="+t+"&"+this.option.ajaxParams}return e.ajax(this.option.data,i),r},h=function(){var t=this,n=this.inputView.val(),r=[],i=!0,s=[];if(e.trim(n).length==0){a.apply(t);return}if(e.isFunction(this.option.beforeLoadDataHandler))try{i=this.option.beforeLoadDataHandler.apply(this,[n])}catch(o){p.apply(this,["调用beforeLoadDataHandler错误:"+o]);return}if(i)if(e.isArray(this.option.data))r=this.option.data;else if(e.isFunction(this.option.data))try{r=this.option.data.apply(this,[n])}catch(o){p.apply(this,["调用data错误:"+o]);return}else{if(typeof this.option.data!="string"){p.apply(this,["遇到未知的data参数！"]);return}try{r=c.apply(this,[n])}catch(o){p.apply(this,["Ajax错误:"+o]);return}}e.each(r,function(r,i){if(t.option.maxItems>0&&s.length>=t.option.maxItems)return!1;if(e.isPlainObject(i))var o=e.extend(!1,{},i);else{if(typeof i!="string")return p.apply(t,["数据源Item类型错误！"]),!1;var o={label:i,value:i,image:i}}t.option.matchHandler.apply(t,[n,o])&&s.push(o)}),n==this.inputView.val()&&(s.length>0?u.apply(this,[s]):a.apply(this))},p=function(t){e.isFunction(this.option.onerror)&&this.option.onerror.apply(this,[t])};t.prototype.setOption=function(t){if(e.isPlainObject(t))this.option=e.extend(!1,this.option,t);else{if(typeof t!="string"){p.apply(this,["未知的AutoComplete参数类型！"]);return}switch(t){case"destroy":this.destroy();break;case"show":this.show();break;default:p.apply(this,["未知的AutoComplete参数！"]);return}}},t.prototype.destroy=function(){this.searchView.remove(),this.inputView.unbind("keyup",this._keyup).unbind("keydown",this._keydown).unbind("blur",this._blur),delete this.inputView.get(0).controller},t.prototype.show=function(){this.option.async?setTimeout(function(){h.apply(this)},0):h.apply(this)};var d=function(t,n){var r=RegExp(t.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),"i");return this.option.emphasis&&e.isFunction(this.option.emphasisHandler)&&this.option.emphasisHandler.apply(this,[t,n]),r.test(n.value)},v=function(e,t){var n=RegExp("("+e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+")","ig");t.label=t.label.replace(n,"<em>$1</em>")}})(jQuery)